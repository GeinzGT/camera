<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gesture Particle System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- THREE.JS -->
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

<!-- MEDIAPIPE -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: black;
  font-family: sans-serif;
}

#startBtn {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 16px 28px;
  font-size: 16px;
  background: #111;
  color: #00ffff;
  border: 1px solid #00ffff;
  cursor: pointer;
  z-index: 10;
}

#fs {
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 5;
  padding: 8px 12px;
  background: #111;
  color: #fff;
  border: 1px solid #333;
  cursor: pointer;
}

video {
  position: fixed;
  right: 10px;
  bottom: 10px;
  width: 160px;
  opacity: 0.15;
}
</style>
</head>
<body>

<button id="startBtn">Start Camera</button>
<button id="fs">Fullscreen</button>
<video id="video" autoplay playsinline></video>

<script>
/* =========================
   THREE SETUP
========================= */
const scene = new THREE.Scene()
scene.fog = new THREE.Fog(0x000000, 10, 80)

const camera = new THREE.PerspectiveCamera(
  60,
  window.innerWidth / window.innerHeight,
  0.1,
  100
)
camera.position.z = 30

const renderer = new THREE.WebGLRenderer({ antialias: true })
renderer.setSize(window.innerWidth, window.innerHeight)
renderer.setPixelRatio(window.devicePixelRatio)
document.body.appendChild(renderer.domElement)

/* =========================
   PARTICLES
========================= */
const COUNT = 6000
const geometry = new THREE.BufferGeometry()
const positions = new Float32Array(COUNT * 3)

for (let i = 0; i < COUNT; i++) {
  const i3 = i * 3
  positions[i3]     = (Math.random() - 0.5) * 15
  positions[i3 + 1] = (Math.random() - 0.5) * 15
  positions[i3 + 2] = (Math.random() - 0.5) * 15
}

geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3))

const material = new THREE.PointsMaterial({
  size: 0.15,
  color: 0x00ffff,
  transparent: true,
  opacity: 0.9,
  blending: THREE.AdditiveBlending
})

const particles = new THREE.Points(geometry, material)
scene.add(particles)

/* =========================
   HAND TRACKING
========================= */
const video = document.getElementById('video')
let targetScale = 1

const hands = new Hands({
  locateFile: file =>
    `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
})

hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
})

hands.onResults(res => {
  if (!res.multiHandLandmarks) return

  const lm = res.multiHandLandmarks[0]
  const thumb = lm[4]
  const index = lm[8]

  const dx = thumb.x - index.x
  const dy = thumb.y - index.y
  const dist = Math.sqrt(dx * dx + dy * dy)

  targetScale = THREE.MathUtils.clamp(dist * 6, 0.6, 2.5)
})

const cam = new Camera(video, {
  onFrame: async () => {
    await hands.send({ image: video })
  },
  width: 640,
  height: 480
})

document.getElementById('startBtn').onclick = () => {
  cam.start()
  document.getElementById('startBtn').remove()
}

/* =========================
   ANIMATE
========================= */
function animate() {
  requestAnimationFrame(animate)

  particles.scale.x += (targetScale - particles.scale.x) * 0.08
  particles.scale.y += (targetScale - particles.scale.y) * 0.08
  particles.scale.z += (targetScale - particles.scale.z) * 0.08

  particles.rotation.y += 0.0015

  renderer.render(scene, camera)
}
animate()

/* =========================
   EVENTS
========================= */
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight
  camera.updateProjectionMatrix()
  renderer.setSize(window.innerWidth, window.innerHeight)
})

document.getElementById('fs').onclick = () => {
  if (!document.fullscreenElement) {
    document.body.requestFullscreen()
  } else {
    document.exitFullscreen()
  }
}
</script>
</body>
</html>
